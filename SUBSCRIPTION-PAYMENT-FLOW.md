# 💳 זרימת תשלום מנוי חודשי - מדריך מלא

## 🎯 2 סוגי תשלומים במערכת:

### **1️⃣ תשלום התקנה (חד-פעמי)**
```
אדמין:
1. נכנס ל-/admin/customers/[id]
2. לוחץ "צור חשבונית ושלח לתשלום"
3. מוסיף פריטים (מצלמות, NVR, עבודה...)
4. שולח ללקוח

לקוח:
1. מקבל לינק: /invoice/[invoiceId]
2. רואה חשבונית מפורטת ויפה
3. לוחץ "שלם עכשיו"
4. נכנס לדף Grow
5. משלם
6. מסומן כ-"שולם" במערכת
```

### **2️⃣ תשלום מנוי (חוזר)**
```
אדמין:
1. נכנס ל-/admin/customers/[id]
2. לוחץ "הפעל חיוב חודשי אוטומטי"
3. מאשר
4. המערכת:
   - יוצרת מנוי ב-DB
   - שולחת פרטים ל-Grow
   - קובעת תאריך חיוב ראשון (בעוד חודש)

חודש עובר...

Grow (אוטומטית):
1. תאריך חיוב מגיע
2. Grow שולחת אימייל/SMS ללקוח:
   "היי! הגיע זמן החיוב החודשי שלך"
   "סכום: ₪149"
   "לחץ כאן לתשלום" [כפתור]
   
3. לקוח לוחץ על הכפתור
4. נפתח דף תשלום של Grow
5. לקוח משלם בכרטיס אשראי

לאחר תשלום:
1. Grow שולחת Webhook למערכת שלנו
2. /api/webhooks/grow מעדכן:
   - payment.status = "completed"
   - payment.paid_at = NOW()
   - subscription.last_billing_date = NOW()
   - subscription.next_billing_date = +1 חודש
   
3. לקוח רואה ב-/dashboard/payments:
   - תשלום חדש סטטוס: ✅ שולם
   - כפתור: "📄 צפה בחשבונית"
   
4. לקוח לוחץ על הכפתור
5. נפתח /subscription-invoice/[paymentId]
6. לקוח רואה חשבונית יפה עם פרטים
```

---

## 📧 מה לקוח מקבל באימייל מ-Grow?

```
נושא: הגיע זמן החיוב החודשי שלך - Clearpoint Security

היי [שם הלקוח],

הגיע הזמן לחדש את המנוי החודשי שלך!

פרטי חיוב:
• שירות: Clearpoint Security - Cloud CCTV
• תקופה: 01/11/2024 - 01/12/2024
• סכום: ₪149

[כפתור: שלם עכשיו]

הכרטיס שלך יחויב אוטומטית.
לשאלות, צור קשר בsupport@clearpoint-security.com

תודה,
צוות Clearpoint Security
```

---

## 🔧 הגדרת Grow (בפרודקשן):

### **שלב 1: הגדרת Webhook**
```
פורטל Grow → הגדרות → Webhooks
↓
Webhook URL: https://yourdomain.com/api/webhooks/grow
Method: POST
Events: 
  ✅ payment_completed
  ✅ payment_failed
  ✅ subscription_renewed
```

### **שלב 2: הגדרת תבנית אימייל**
```
Grow → תבניות → תבנית אימייל חיוב חוזר
↓
נושא: הגיע זמן החיוב החודשי - {{company_name}}
תוכן: [התבנית למעלה]
```

### **שלב 3: בדיקה**
```
1. צור מנוי בסביבת Sandbox של Grow
2. Grow שולחת אימייל מדומה
3. לחץ על לינק התשלום
4. בצע תשלום מדומה
5. בדוק ש-Webhook התקבל
6. בדוק שהמערכת עדכנה את הנתונים
```

---

## 🎨 מה הלקוח רואה?

### **א. היסטוריית תשלומים (/dashboard/payments)**
```
┌─────────────────────────────────────────┐
│ 📄 היסטוריית תשלומים                   │
├─────────────────────────────────────────┤
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ ✅ הושלם  |  01/11/2024            │ │
│ │ מנוי חודשי - Clearpoint Security   │ │
│ │ ₪149                                │ │
│ │                                     │ │
│ │ [📄 צפה בחשבונית]                 │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ ✅ הושלם  |  01/10/2024            │ │
│ │ מנוי חודשי - Clearpoint Security   │ │
│ │ ₪149                                │ │
│ │                                     │ │
│ │ [📄 צפה בחשבונית]                 │ │
│ └─────────────────────────────────────┘ │
│                                         │
└─────────────────────────────────────────┘
```

### **ב. חשבונית מנוי (/subscription-invoice/[id])**
```
┌─────────────────────────────────────────┐
│ 🧾 חשבונית מנוי חודשי                  │
│ Clearpoint Security                     │
├─────────────────────────────────────────┤
│                                         │
│ מספר קבלה: REC-A6D9650E                │
│ תאריך: 01/11/2024                       │
│ סטטוס: ✅ שולם                         │
│                                         │
│ תקופת חיוב:                             │
│ 01/11/2024 - 01/12/2024                 │
│                                         │
│ פרטי לקוח:                              │
│ ישראל ישראלי                            │
│ israel@example.com                      │
│                                         │
│ ─────────────────────────────────────   │
│ פירוט:                                  │
│ • מנוי חודשי Clearpoint Security       │
│   ₪149 x 1 = ₪149                      │
│                                         │
│ סה"כ: ₪149                              │
│                                         │
└─────────────────────────────────────────┘
```

---

## 🔍 FAQ - שאלות נפוצות:

### **ש: איך הלקוח יודע שהגיע זמן לשלם?**
ת: Grow שולחת אימייל/SMS אוטומטית עם לינק תשלום.

### **ש: האם הלקוח צריך להיכנס לאתר שלנו?**
ת: לא! הלקוח לוחץ על הלינק באימייל ונכנס ישירות לדף התשלום של Grow.

### **ש: איפה הלקוח רואה חשבונית?**
ת: בדשבורד שלו: /dashboard/payments → "צפה בחשבונית"

### **ש: מה קורה אם הלקוח לא משלם?**
ת: 
1. Grow שולחת תזכורת אוטומטית
2. לאחר 3 ימים: סטטוס משתנה ל-"past_due"
3. לאחר 7 ימים: המנוי מתבטל אוטומטית

### **ש: איך אני (אדמין) יודע שהלקוח שילם?**
ת:
1. דף הלקוח: /admin/customers/[id] → SubscriptionManager מראה סטטוס
2. Webhook מעדכן אוטומטית
3. אפשר להוסיף התראות (בעתיד)

---

## 📝 לסיכום:

**תשלום התקנה:**
- ✅ אדמין שולח חשבונית ידנית
- ✅ לקוח רואה חשבונית מפורטת
- ✅ חד-פעמי

**תשלום מנוי:**
- ✅ Grow שולחת אוטומטית
- ✅ לקוח מקבל אימייל/SMS
- ✅ חוזר כל חודש
- ✅ יש חשבונית בדשבורד

**הכל אוטומטי! 🎉**
